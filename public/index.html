<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Skintelli Antioxidant Score</title>
<style>
body{font-family:system-ui,Arial,sans-serif;max-width:680px;margin:40px auto}
label{display:block;margin-bottom:.5rem} #out{font-size:1.4rem;margin-top:1rem}
</style>

<script src="https://cdn.jsdelivr.net/pyodide/v0.25.1/full/pyodide.js"></script>
<script async src="https://docs.opencv.org/4.x/opencv.js"></script>
</head>
<body>
<h2>Skintelli Antioxidant Score</h2>

<label>Choose card photo:
  <input type="file" id="file" accept="image/*">
</label>

<div id="out">‚è≥ loading engine‚Ä¶</div>

<script type="module">
/* helpful util ---------------------------------------------------*/
const show = msg => document.getElementById('out').textContent = msg;

try {
  /* 1) boot Pyodide + SciPy stack */
  const py = await loadPyodide({indexURL:"https://cdn.jsdelivr.net/pyodide/v0.25.1/full/"});
  await py.loadPackage(['numpy','pandas','scikit-image']);

  /* 2) wait for opencv.js */
  await new Promise(res => { cv['onRuntimeInitialized'] = res; });

  /* 3) fetch lookup CSV and write into Pyodide FS *before* running code */
  const csvText = await fetch('trainingLab.csv').then(r => r.text());
  py.FS.writeFile('/tmp/training.csv', csvText);

  /* 4) inject Python scorer */
  await py.runPythonAsync(`
import numpy as np, pandas as pd, cv2 as cv, io
from skimage.color import rgb2lab, deltaE_ciede2000 as dE

# ---- load lookup ----
_table = pd.read_csv('/tmp/training.csv')
LAB  = _table[['L','a','b']].values
SCORE= _table['score'].values

W,H=1000,500; BOX=0.06; PAD=0.08; PX=0.92; SY=0.20; CY=0.60
def delta(l1,l2): return float(dE(l1[None],l2[None])[0])

def warp(img):
    h,w=img.shape[:2]
    g=cv.GaussianBlur(cv.cvtColor(img,cv.COLOR_BGR2GRAY),(5,5),0)
    c,_=cv.findContours(cv.Canny(g,50,150),cv.RETR_EXTERNAL,cv.CHAIN_APPROX_SIMPLE)
    q=max((x for x in c if 0.25*w*h<cv.contourArea(x)<0.9*w*h),
          key=cv.contourArea, default=None)
    if q is None: return cv.resize(img,(W,H))
    peri=cv.arcLength(q,True)
    a=cv.approxPolyDP(q,0.02*peri,True)
    if len(a)!=4: return cv.resize(img,(W,H))
    pts=np.squeeze(a).astype(np.float32)
    s,d=pts.sum(1),np.diff(pts,axis=1).ravel()
    ord=np.array([pts[np.argmin(s)],pts[np.argmin(d)],
                  pts[np.argmax(s)],pts[np.argmax(d)]] ,np.float32)
    dst=np.array([[0,0],[W-1,0],[W-1,H-1],[0,H-1]],np.float32)
    return cv.warpPerspective(img,cv.getPerspectiveTransform(ord,dst),(W,H))

def crop(img,cx,cy,s):
    h,w=img.shape[:2]; side=int(s*w)
    x,y=int(cx*w)-side//2,int(cy*h)-side//2
    return img[max(0,y):y+side,max(0,x):x+side]

def medLAB(bgr):
    return np.median(rgb2lab(cv.cvtColor(bgr,cv.COLOR_BGR2RGB)).reshape(-1,3),0)

def score_array(bgr):
    card=warp(bgr)
    printed=[medLAB(crop(card,0.05+i*0.13,0.75,BOX)) for i in range(6)]
    samp,ctrl = (medLAB(crop(card,PX,sy,PAD)) for sy in (SY,CY))
    wb=np.array([95-ctrl[0],-ctrl[1],-ctrl[2]])
    samp_c=samp+wb; printed_c=[p+wb for p in printed]
    d=np.array([delta(samp_c,x) for x in LAB])
    if d.min()<=3: raw=SCORE[d.argmin()]
    else:
        w=np.exp(-np.array([delta(samp_c,p) for p in printed_c])/2.5)
        raw=(w*np.arange(6)).sum()/w.sum()
    return round(np.clip(raw,0,5)*4)/4

def score_from_js(buf,h,w):
    return score_array(np.frombuffer(buf,dtype=np.uint8).reshape(h,w,3).copy())
  `);

  show('Python ready ‚Äì pick a photo.');

  /* 5) handle file input */
  document.getElementById('file').addEventListener('change', async e=>{
    const f = e.target.files[0]; if(!f) return;
    show('üñºÔ∏è decoding‚Ä¶');

    /* decode with OpenCV.js */
    const u8 = new Uint8Array(await f.arrayBuffer());
    const mat = cv.matFromArray(u8,1);
    const img = cv.imdecode(mat,cv.IMREAD_COLOR);
    mat.delete();
    const {rows:h, cols:w} = img;
    const data = new Uint8Array(img.data);
    img.delete();

    /* pass to Python */
    py.globals.set('buf_js', data);
    py.globals.set('h_js', h);
    py.globals.set('w_js', w);
    const score = py.runPython('score_from_js(buf_js, int(h_js), int(w_js))');
    show('‚úÖ Antioxidant Score: '+score);
  });

} catch(err){
  console.error(err);
  show('‚ö†Ô∏è '+err);
}
</script>
</body>
</html>
