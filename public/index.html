<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Card Capture (simple)</title>
<style>
 html,body{margin:0;height:100%;overflow:hidden;background:#000;font-family:-apple-system,Roboto,Helvetica,Arial,sans-serif}
 #cam,#prev{position:absolute;inset:0;display:flex;align-items:center;justify-content:center}
 video,canvas{position:absolute;inset:0;width:100%;height:100%;object-fit:cover}
 canvas{pointer-events:none;z-index:10}
 #msg{position:absolute;top:16px;left:50%;transform:translateX(-50%);padding:6px 12px;border-radius:8px;
      background:rgba(0,0,0,.6);color:#fff;font-size:15px;z-index:20}
 button{padding:14px 36px;font-size:17px;border:none;border-radius:48px;background:#fff;color:#000;transition:.2s}
 #snap{position:absolute;bottom:60px;left:50%;transform:translateX(-50%);opacity:.35}
 #snap.active{opacity:1}
 #dl,#rt{display:none;margin:10px 20px}
 #prev img{max-width:96%;max-height:96%;border:4px solid #fff;border-radius:8px}
</style>
</head>
<body>
<div id="cam">
  <video id="v" autoplay playsinline></video>
  <canvas id="c"></canvas>
  <div id="msg">Opening camera…</div>
  <button id="snap">Capture</button>
</div>

<div id="prev" style="display:none;flex-direction:column">
  <img id="shot" alt="">
  <div>
    <button id="dl">Download</button>
    <button id="rt">Retake</button>
  </div>
</div>

<script type="module">
const v=document.getElementById('v'), cv=document.getElementById('c'), ctx=cv.getContext('2d');
const msg=document.getElementById('msg'), snap=document.getElementById('snap');
const shot=document.getElementById('shot'), dl=document.getElementById('dl'), rt=document.getElementById('rt');
const CARD_RATIO=1280/726,   // 1.76  (width / height)
      MARGIN=.10, BRIGHT=50; // brightness threshold

navigator.mediaDevices.getUserMedia({video:{facingMode:{ideal:'environment'}}}).then(s=>{
  v.srcObject=s;
  v.onloadedmetadata=()=>{cv.width=v.videoWidth;cv.height=v.videoHeight;loop();}
});

function loop(){
  if(v.readyState<2) return requestAnimationFrame(loop);

  /* 1) quick brightness check – sample 32 px */
  const tmp=document.createElement('canvas'); tmp.width=8; tmp.height=4;
  const tctx=tmp.getContext('2d'); tctx.drawImage(v,0,0,8,4);
  const d=tctx.getImageData(0,0,8,4).data; let lum=0;
  for(let i=0;i<d.length;i+=4) lum+=(d[i]+d[i+1]+d[i+2])/3;
  const brightOK=(lum/(d.length/4))>BRIGHT;

  /* 2) landscape check */
  const landOK = v.videoWidth>v.videoHeight;

  const good = brightOK && landOK;
  drawGuide(good);

  msg.textContent = brightOK ? (good?'Ready – tap Capture':'Align card to guide')
                             : 'Too dark – add light';
  snap.classList.toggle('active',good);

  requestAnimationFrame(loop);
}

function drawGuide(good){
  const W=cv.width,H=cv.height;
  ctx.clearRect(0,0,W,H);
  const maxW=W*(1-MARGIN*2); let gw=maxW,gh=gw/CARD_RATIO;
  if(gh>H*(1-MARGIN*2)){gh=H*(1-MARGIN*2);gw=gh*CARD_RATIO;}
  const x=(W-gw)/2,y=(H-gh)/2;

  ctx.lineWidth=4; ctx.strokeStyle=good?'#0f0':'#f00';
  ctx.strokeRect(x,y,gw,gh);
  ctx.strokeStyle='rgba(255,255,255,.5)'; ctx.lineWidth=1;
  for(let i=1;i<3;i++){
    ctx.beginPath();ctx.moveTo(x+gw*i/3,y);ctx.lineTo(x+gw*i/3,y+gh);ctx.stroke();
    ctx.beginPath();ctx.moveTo(x,y+gh*i/3);ctx.lineTo(x+gw,y+gh*i/3);ctx.stroke();
  }
}

snap.onclick=()=>{
  if(!snap.classList.contains('active'))return;
  const shotCanvas=document.createElement('canvas');
  shotCanvas.width=v.videoWidth;shotCanvas.height=v.videoHeight;
  shotCanvas.getContext('2d').drawImage(v,0,0);
  const url=shotCanvas.toDataURL('image/jpeg',0.9);

  document.getElementById('cam').style.display='none';
  document.getElementById('prev').style.display='flex';
  shot.src=url; dl.style.display=rt.style.display='inline-block';

  dl.onclick=()=>{const a=document.createElement('a');a.href=url;a.download='card.jpg';a.click();};
  rt.onclick=()=>{document.getElementById('prev').style.display='none';
                  document.getElementById('cam').style.display='block';};
};
</script>
</body>
</html>
