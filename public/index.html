<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Skintelli Antioxidant Score</title>
  <style>
    body { font-family: system-ui, Arial, sans-serif; max-width: 680px; margin: 40px auto; }
    label { display: block; margin-bottom: .5rem; }
    #out  { font-size: 1.4rem; margin-top: .8rem; }
  </style>
  <!-- Pyodide -->
  <script src="https://cdn.jsdelivr.net/pyodide/v0.25.1/full/pyodide.js"></script>
  <!-- OpenCV.js (NO async, defer, or module) -->
  <script>
    window._opencvReady = false;
    window.Module = { onRuntimeInitialized: () => { window._opencvReady = true; } };
  </script>
  <script src="https://docs.opencv.org/4.x/opencv.js"></script>
</head>
<body>
  <h2>Skintelli Antioxidant Score</h2>
  <label>
    Choose card photo:
    <input type="file" id="file" accept="image/*">
  </label>
  <div id="out">‚è≥ loading engine‚Ä¶</div>
  <script type="module">
    const out = document.getElementById('out');
    const show = msg => out.textContent = msg;

    // --- Wait for OpenCV.js ---
    show('‚è≥ loading OpenCV‚Ä¶');
    await new Promise(resolve => {
      if (window._opencvReady) return resolve();
      const interval = setInterval(() => {
        if (window._opencvReady) {
          clearInterval(interval);
          resolve();
        }
      }, 20);
    });
    show('‚úÖ OpenCV ready');

    // --- Pyodide ---
    show('‚è≥ loading Python‚Ä¶');
    const py = await loadPyodide({ indexURL: "https://cdn.jsdelivr.net/pyodide/v0.25.1/full/" });
    await py.loadPackage(['numpy', 'pandas', 'scikit-image']);
    show('‚úÖ Python ready');

    // --- CSV ---
    show('‚è≥ loading reference table‚Ä¶');
    const csvText = await fetch('trainingLab.csv').then(r => r.text());
    py.FS.writeFile('/tmp/training.csv', csvText);
    show('‚úÖ Reference table loaded');

    // --- Python scorer ---
    show('‚è≥ compiling scorer‚Ä¶');
    await py.runPythonAsync(`
import numpy as np, pandas as pd
from skimage.color import rgb2lab, deltaE_ciede2000 as dE

df     = pd.read_csv('/tmp/training.csv')
LAB    = df[['L','a','b']].values
SCORES = df['score'].values

def delta(l1, l2): return float(dE(l1[None], l2[None])[0])

def calc_score(sample_lab, printed_labs_lab):
    dists = np.array([delta(sample_lab, r) for r in LAB])
    if dists.min() <= 3:
        raw = SCORES[dists.argmin()]
    else:
        wts = np.exp(-np.array([delta(sample_lab, p) for p in printed_labs_lab]) / 2.5)
        raw = (wts * np.arange(6)).sum() / wts.sum()
    return round(np.clip(raw, 0, 5) * 4) / 4
    `);
    show('‚úÖ Scorer ready ‚Äî pick a photo.');

    // --- File handler: Patch extraction ---
    document.getElementById('file').addEventListener('change', async ev => {
      const f = ev.target.files[0];
      if (!f) return;
      show('üñºÔ∏è decoding & scoring‚Ä¶');

      // Decode
      const buffer = await f.arrayBuffer();
      const u8 = new Uint8Array(buffer);
      const mat = cv.matFromArray(u8, 1);
      let img = cv.imdecode(mat, cv.IMREAD_COLOR);
      mat.delete();

      // --- Resize for consistent patch location ---
      let W = 1000, H = 500;
      let dst = new cv.Mat();
      cv.resize(img, dst, new cv.Size(W, H));
      img.delete();
      img = dst;

      // --- Define patch locations (copy your Python logic) ---
      function cropMean(img, cx, cy, pct) {
        // cx,cy in [0,1], pct is relative width
        let w = img.cols, h = img.rows;
        let side = Math.floor(pct * w);
        let x0 = Math.max(0, Math.floor(cx * w) - Math.floor(side / 2));
        let y0 = Math.max(0, Math.floor(cy * h) - Math.floor(side / 2));
        let roi = img.roi(new cv.Rect(x0, y0, side, side));
        let mean = cv.mean(roi); // [b,g,r,a]
        roi.delete();
        return [mean[2], mean[1], mean[0]]; // [R,G,B]
      }

      // --- Collect printed patch colors ---
      let BOX = 0.06, PAD = 0.08;
      let patch_rgbs = [];
      for (let i = 0; i < 6; ++i)
        patch_rgbs.push(cropMean(img, 0.05 + i * 0.13, 0.75, BOX));

      // --- Sample and control ---
      let PX = 0.92, SY = 0.20, CY = 0.60;
      let sample_rgb  = cropMean(img, PX, SY, PAD);
      let control_rgb = cropMean(img, PX, CY, PAD);
      img.delete();

      // --- White balance adjustment like in your Python logic ---
      let wb = [95 - control_rgb[0], -control_rgb[1], -control_rgb[2]];
      let sample_wb = sample_rgb.map((v, i) => v + wb[i]);
      let printed_wb = patch_rgbs.map(rgb => rgb.map((v, i) => v + wb[i]));

      // --- Pass all to Python for LAB conversion & scoring ---
      let pycode = `
import numpy as np
from skimage.color import rgb2lab

sample_rgb = np.array(${JSON.stringify(sample_wb)}) / 255.
printed_rgbs = np.array(${JSON.stringify(printed_wb)}) / 255.

sample_lab = rgb2lab(sample_rgb[None,None,:]).reshape(3)
printed_labs = np.array([rgb2lab(p[None,None,:]).reshape(3) for p in printed_rgbs])

calc_score(sample_lab, printed_labs)
      `;
      let score = await py.runPythonAsync(pycode);
      show('‚úÖ Antioxidant Score: ' + score);
    });
  </script>
</body>
</html>
