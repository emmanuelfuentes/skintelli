<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Card Capture Overlay</title>
  <style>
    body,html{margin:0;padding:0;overflow:hidden;background:#000}
    #videoElement{position:absolute;top:0;left:0;width:100vw;height:100vh;object-fit:cover;transform:scaleX(-1)}
    #overlayCanvas{position:absolute;top:0;left:0;width:100vw;height:100vh;pointer-events:none}
    #captureButton{position:absolute;bottom:16px;left:50%;transform:translateX(-50%);padding:12px 24px;border:none;border-radius:24px;background:rgba(255,255,255,.8);font-size:18px;font-weight:bold}
  </style>
</head>
<body>
  <video id="videoElement" autoplay playsinline></video>
  <canvas id="overlayCanvas"></canvas>
  <button id="captureButton" disabled>Capture</button>

  <script src="https://docs.opencv.org/4.x/opencv.js" type="text/javascript"></script>
  <script>
    const video=document.getElementById('videoElement');
    const canvas=document.getElementById('overlayCanvas');
    const ctx=canvas.getContext('2d');
    const captureBtn=document.getElementById('captureButton');

    async function setupCamera(){
      const stream=await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'},audio:false});
      video.srcObject=stream;
      return new Promise(res=>video.onloadedmetadata=()=>res());
    }

    let cvReady=false;
    cv['onRuntimeInitialized']=()=>{cvReady=true};

    function processFrame(){
      if(!cvReady){return requestAnimationFrame(processFrame)}
      const width=video.videoWidth;
      const height=video.videoHeight;
      if(width===0||height===0){return requestAnimationFrame(processFrame)}
      canvas.width=width;canvas.height=height;
      ctx.drawImage(video,0,0,width,height);
      let src=cv.imread(canvas);
      let gray=new cv.Mat();
      cv.cvtColor(src,gray,cv.COLOR_RGBA2GRAY);
      cv.GaussianBlur(gray,gray,new cv.Size(5,5),0);
      let edged=new cv.Mat();
      cv.Canny(gray,edged,75,200);
      let contours=new cv.MatVector();
      let hierarchy=new cv.Mat();
      cv.findContours(edged,contours,hierarchy,cv.RETR_LIST,cv.CHAIN_APPROX_SIMPLE);
      let maxArea=0,bestContour=null;
      for(let i=0;i<contours.size();i++){
        let cnt=contours.get(i);
        let peri=cv.arcLength(cnt,true);
        let approx=new cv.Mat();
        cv.approxPolyDP(cnt,approx,0.02*peri,true);
        if(approx.rows===4){
          const area=cv.contourArea(cnt);
          if(area>maxArea){maxArea=area;bestContour=approx}
        }
      }
      ctx.clearRect(0,0,width,height);
      if(bestContour&&maxArea>(width*height*0.05)){
        ctx.lineWidth=4;ctx.strokeStyle='#00FF00';ctx.beginPath();
        const pts=[];
        for(let i=0;i<4;i++){pts.push({x:bestContour.data32S[i*2],y:bestContour.data32S[i*2+1]})}
        pts.sort((a,b)=>a.x+a.y-(b.x+b.y));
        ctx.moveTo(pts[0].x,pts[0].y);
        for(let i=1;i<4;i++){ctx.lineTo(pts[i].x,pts[i].y)}
        ctx.closePath();ctx.stroke();
        captureBtn.disabled=false;
        captureBtn.onclick=()=>saveImage(pts);
      }else{captureBtn.disabled=true}
      src.delete();gray.delete();edged.delete();contours.delete();hierarchy.delete();
      if(bestContour)bestContour.delete();
      requestAnimationFrame(processFrame);
    }

    function saveImage(cardPoints){
      const link=document.createElement('a');
      link.download='card.jpg';
      link.href=canvas.toDataURL('image/jpeg',0.92);
      link.click();
    }

    (async()=>{await setupCamera();requestAnimationFrame(processFrame)})();
  </script>
</body>
</html>
