<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Card Scanner – rectangle check</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
/* ── same styling as before (omitted here for brevity, nothing changed) ── */
html,body{margin:0;height:100%;overflow:hidden;background:#000;font-family:-apple-system,Roboto,Helvetica,Arial,sans-serif}
#cam,#preview{position:absolute;inset:0;display:flex;align-items:center;justify-content:center}
video,canvas{position:absolute;inset:0;width:100%;height:100%;object-fit:cover}
canvas{pointer-events:none;z-index:10}
#msg{position:absolute;top:14px;left:50%;transform:translateX(-50%);padding:6px 14px;border-radius:8px;background:rgba(0,0,0,.65);color:#fff;font-size:15px;z-index:20}
#hint{position:absolute;left:50%;transform:translateX(-50%);color:#fff;font-size:15px;text-align:center;pointer-events:none;z-index:20}
#fatal{position:absolute;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.85);color:#fff;font-size:17px;text-align:center;padding:24px;z-index:40}
#snap{position:absolute;bottom:42px;left:50%;transform:translateX(-50%);width:80px;height:80px;border-radius:50%;border:4px solid #fff;background:rgba(255,255,255,.15);display:flex;align-items:center;justify-content:center;opacity:.3;pointer-events:none;transition:.2s ease;z-index:20}
#snap::after{content:'';width:54px;height:54px;border-radius:50%;background:#fff}
#snap.ready{opacity:1}
#snap.ready::after{background:#0f0}
#preview{flex-direction:column;gap:18px;background:#000;display:none}
#shot{max-width:96%;max-height:96%;border:4px solid #fff;border-radius:10px}
.ctrls button{padding:12px 26px;font-size:16px;border:none;border-radius:40px;margin:0 10px;background:#fff}
</style>
</head>
<body>

<div id="cam">
  <video id="video" autoplay playsinline muted></video>
  <canvas id="overlay"></canvas>

  <div id="msg">Tap to enable camera</div>
  <div id="hint"></div>
  <button id="snap" aria-label="Shutter"></button>

  <div id="fatal"></div>
</div>

<div id="preview">
  <img id="shot" alt="">
  <div class="ctrls">
    <button id="download">Download</button>
    <button id="retake">Retake</button>
  </div>
</div>

<script type="module">
/* ───── parameters ───── */
const CARD_RATIO   = 1280/726;        // 1.7627
const GUIDE_MARGIN = 0.08;            // 8 %
const BRIGHT_MIN   = 55;              // luminance
const COVER_MIN    = 0.85;            // rectangle must cover ≥85 % both ways
const AR_TOL       = 0.15;            // ±15 % aspect-ratio tolerance
const DEST_W       = 1280;            // output width

/* ───── DOM refs ───── */
const v=document.getElementById('video'), c=document.getElementById('overlay'), x=c.getContext('2d');
const m=document.getElementById('msg'), h=document.getElementById('hint'), f=document.getElementById('fatal');
const bt=document.getElementById('snap'), img=document.getElementById('shot'), dl=document.getElementById('download'), rt=document.getElementById('retake');
const cam=document.getElementById('cam'), prev=document.getElementById('preview');

/* ───── globals ───── */
let guide, ready=false;
const off=document.createElement('canvas');

/* ───── camera bootstrap ───── */
const kick=()=>{document.removeEventListener('touchstart',kick);document.removeEventListener('click',kick);init();};
document.addEventListener('touchstart',kick,{once:true});document.addEventListener('click',kick,{once:true});

async function init(){
  m.textContent='Requesting camera…';
  try{
    const s=await navigator.mediaDevices.getUserMedia({video:{facingMode:{ideal:'environment'}}});
    v.srcObject=s;await v.play().catch(()=>{});
  }catch(e){fatal(e);return;}

  const boot=()=>{if(!v.videoWidth)return;
    c.width=off.width=v.videoWidth;c.height=off.height=v.videoHeight;
    guide=calcGuide(c.width,c.height);m.textContent='Align card inside brackets';requestAnimationFrame(loop);
    v.removeEventListener('playing',boot);v.removeEventListener('loadedmetadata',boot);clearInterval(poll);};
  v.addEventListener('playing',boot,{once:true});v.addEventListener('loadedmetadata',boot,{once:true});
  const poll=setInterval(boot,100);
}

/* ───── helpers ───── */
function calcGuide(W,H){const maxW=W*(1-GUIDE_MARGIN*2);let w=maxW,h=w/CARD_RATIO;if(h>H*(1-GUIDE_MARGIN*2)){h=H*(1-GUIDE_MARGIN*2);w=h*CARD_RATIO;}return{x:(W-w)/2,y:(H-h)/2,w,h};}
function drawGuide(g){const{ x,y,w,h }=guide; xC(); const L=40; x.lineWidth=6; x.strokeStyle=g?'#0f0':'#fff';
 function xC(){x.clearRect(0,0,c.width,c.height);} x.beginPath();
 x.moveTo(x,y+L);x.lineTo(x,y);x.lineTo(x+L,y);
 x.moveTo(x+w-L,y);x.lineTo(x+w,y);x.lineTo(x+w,y+L);
 x.moveTo(x+w,y+h-L);x.lineTo(x+w,y+h);x.lineTo(x+w-L,y+h);
 x.moveTo(x+L,y+h);x.lineTo(x,y+h);x.lineTo(x,y+h-L);x.stroke();
 x.lineWidth=1;x.strokeStyle='rgba(255,255,255,.4)';
 for(let i=1;i<3;i++){x.beginPath();x.moveTo(x+w*i/3,y);x.lineTo(x+w*i/3,y+h);x.stroke();
   x.beginPath();x.moveTo(x,y+h*i/3);x.lineTo(x+w,y+h*i/3);x.stroke();}
 hElem.style.top=`${y+h+20}px`;}
const hElem=h; /* alias */

/* edge helper */
function rectOK(img,w,h){let minX=w,minY=h,maxX=0,maxY=0,edges=0;
 for(let y=0;y<h-1;y++){for(let x=0;x<w-1;x++){const i=(y*w+x)*4;
   const lum=(img[i]+img[i+1]+img[i+2])/3, lumR=(img[i+4]+img[i+5]+img[i+6])/3, lumD=(img[i+w*4]+img[i+w*4+1]+img[i+w*4+2])/3;
   const e=Math.abs(lum-lumR)>25||Math.abs(lum-lumD)>25;if(e){edges++;if(x<minX)minX=x;if(y<minY)minY=y;if(x>maxX)maxX=x;if(y>maxY)maxY=y;}}}
 if(edges<200) return false;
 const bw=maxX-minX, bh=maxY-minY;
 if(bw<1||bh<1) return false;
 const coverW=bw/w, coverH=bh/h;
 const ar=bw/bh, arOK=Math.abs(ar-CARD_RATIO)/CARD_RATIO<AR_TOL;
 return coverW>COVER_MIN&&coverH>COVER_MIN&&arOK;}

/* ───── main loop ───── */
function loop(){
  if(v.readyState<2){requestAnimationFrame(loop);return;}
  off.getContext('2d').drawImage(v,0,0);
  const{ x,y,w,h }=guide, ctxOff=off.getContext('2d');
  const data=ctxOff.getImageData(x,y,w,h);
  /* brightness */
  let sum=0;for(let i=0;i<data.data.length;i+=4)sum+=(data.data[i]+data.data[i+1]+data.data[i+2])/3;
  const brightOK=(sum/(data.data.length/4))>BRIGHT_MIN;
  const rectPresent=rectOK(data.data,w,h);
  ready=brightOK&&rectPresent;
  drawGuide(ready);
  h.textContent=ready?'Hold steady and press shutter':(brightOK?'Move card fully inside brackets':'Add more light');
  m.textContent=ready?'Ready – press shutter':'Align card inside brackets';
  bt.classList.toggle('ready',ready);
  requestAnimationFrame(loop);
}

/* ───── shutter ───── */
bt.onclick=()=>{
  if(!ready)return;
  const{ x,y,w,h }=guide;
  off.getContext('2d').drawImage(v,0,0);
  const out=document.createElement('canvas');
  out.width=DEST_W;out.height=Math.round(DEST_W/CARD_RATIO);
  out.getContext('2d').drawImage(off,x,y,w,h,0,0,out.width,out.height);
  const url=out.toDataURL('image/jpeg',0.92);
  cam.style.display='none';prev.style.display='flex';
  img.src=url; dl.onclick=()=>{const a=document.createElement('a');a.href=url;a.download='card.jpg';a.click();};
  rt.onclick=()=>{prev.style.display='none';cam.style.display='block';};
};

/* ───── fatal helper ───── */
function fatal(err){f.innerHTML=err;f.style.display='flex';m.style.display='none';bt.style.display='none';}
</script>
</body>
</html>
