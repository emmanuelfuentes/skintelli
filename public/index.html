<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Skintelli Antioxidant Analyzer</title>
<style>
body{font-family:system-ui,Arial, sans-serif;max-width:680px;margin:40px auto}
label{display:block;margin-bottom:.5rem} #out{font-size:1.4rem;margin-top:1rem}
</style>

<!-- Pyodide (Python in WebAssembly) -->
<script src="https://cdn.jsdelivr.net/pyodide/v0.25.1/full/pyodide.js"></script>
<!-- opencv.js -->
<script async src="https://docs.opencv.org/4.x/opencv.js"></script>
</head>
<body>
<h2>Skintelli Antioxidant Score</h2>

<label>Choose card photo:
  <input type="file" id="file" accept="image/*" />
</label>

<div id="out">‚è≥ loading engine‚Ä¶</div>

<script type="module">
const out = document.getElementById('out');
let py = await loadPyodide({indexURL:"https://cdn.jsdelivr.net/pyodide/v0.25.1/full/"});
await py.loadPackage(['numpy','pandas','scikit-image']);
await new Promise(r=>{cv['onRuntimeInitialized']=r});  // make sure opencv.js is ready
out.textContent='Python ready ‚Äì pick a photo.';

/* ---------- embed CSV (loaded via fetch) ---------- */
const csvText = await fetch('trainingLab.csv').then(r=>r.text());

/* ---------- inject the Python scorer ---------- */
py.runPython(`
import numpy as np, pandas as pd, io, cv2 as cv
from skimage.color import rgb2lab, deltaE_ciede2000 as dE

# ---- load lookup table from JS ----
_table = pd.read_csv(io.StringIO(pyodide.FS.readFile('/tmp/csv', 'utf8')))
TABLE_LAB   = _table[['L','a','b']].values
TABLE_SCORE = _table['score'].values

# ---- constants ----
W,W2,H = 1000,500,500
BOX=0.06; PAD=0.08; PAD_X=0.92; S_Y=0.20; C_Y=0.60

def deltaE(l1,l2): return float(dE(l1[None],l2[None])[0])

def warp(img):
    h,w=img.shape[:2]
    g=cv.GaussianBlur(cv.cvtColor(img,cv.COLOR_BGR2GRAY),(5,5),0)
    c,_=cv.findContours(cv.Canny(g,50,150),cv.RETR_EXTERNAL,cv.CHAIN_APPROX_SIMPLE)
    q=max((cnt for cnt in c if 0.25*w*h<cv.contourArea(cnt)<0.9*w*h),
          key=cv.contourArea, default=None)
    if q is None: return cv.resize(img,(W,H))
    peri=cv.arcLength(q,True)
    a=cv.approxPolyDP(q,0.02*peri,True)
    if len(a)!=4: return cv.resize(img,(W,H))
    pts=np.squeeze(a).astype(np.float32)
    s=pts.sum(1); d=np.diff(pts,axis=1).ravel()
    ord=np.array([pts[np.argmin(s)],pts[np.argmin(d)],
                  pts[np.argmax(s)],pts[np.argmax(d)]])
    dst=np.array([[0,0],[W-1,0],[W-1,H-1],[0,H-1]],np.float32)
    M=cv.getPerspectiveTransform(ord,dst)
    return cv.warpPerspective(img,M,(W,H))

def crop(img,cx,cy,side):
    h,w=img.shape[:2]; s=int(side*w)
    x,y=int(cx*w)-s//2,int(cy*h)-s//2
    return img[max(0,y):y+s,max(0,x):x+s]

def medLAB(bgr):
    return np.median(rgb2lab(cv.cvtColor(bgr,cv.COLOR_BGR2RGB)).reshape(-1,3),0)

def score_nd(bgr):
    card=warp(bgr)
    printed=[medLAB(crop(card,0.05+i*0.13,0.75,BOX)) for i in range(6)]
    samp   = medLAB(crop(card,PAD_X,S_Y,PAD))
    ctrl   = medLAB(crop(card,PAD_X,C_Y,PAD))
    wb = np.array([95-ctrl[0],-ctrl[1],-ctrl[2]])
    samp_c = samp+wb; printed_c=[p+wb for p in printed]
    d=np.array([deltaE(samp_c, r) for r in TABLE_LAB])
    if d.min()<=3: raw=TABLE_SCORE[d.argmin()]
    else:
        w=np.exp(-np.array([deltaE(samp_c,b) for b in printed_c])/2.5)
        raw=(w*np.arange(6)).sum()/w.sum()
    return round(np.clip(raw,0,5)*4)/4

def score_from_buffer(buf,h,w):
    bgr=np.frombuffer(buf,dtype=np.uint8).reshape(h,w,3).copy()
    return score_nd(bgr)
`);
/* write CSV into Pyodide FS */
py.FS.writeFile('/tmp/csv', csvText);

/* ---------- UI: handle file ---------- */
document.getElementById('file').addEventListener('change', async e=>{
  const file=e.target.files[0]; if(!file)return;
  out.textContent='üñºÔ∏è processing‚Ä¶';

  /* decode via opencv.js */
  const buf=new Uint8Array(await file.arrayBuffer());
  const mat=cv.matFromArray(buf,1);
  const img=cv.imdecode(mat,cv.IMREAD_COLOR); mat.delete();
  const {rows:h,cols:w}=img;
  const data=new Uint8Array(img.data); img.delete();

  /* pass to Python */
  py.globals.set('js_buf', data);
  py.globals.set('h', h); py.globals.set('w', w);

  const score = py.runPython('score_from_buffer(js_buf, int(h), int(w))');
  out.textContent='‚úÖ Antioxidant Score: '+score;
});
</script>
</body>
</html>
