<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Skintelli Antioxidant Score</title>
  <style>
    body { font-family: system-ui, Arial, sans-serif; max-width: 680px; margin: 40px auto; }
    label { display: block; margin-bottom: .5rem; }
    #out  { font-size: 1.4rem; margin-top: .8rem; }
  </style>

  <!-- 1) Pyodide: Python in the browser -->
  <script src="https://cdn.jsdelivr.net/pyodide/v0.25.1/full/pyodide.js"></script>
  <!-- 2) OpenCV.js: computer vision -->
<script src="opencv.js"></script>
</head>
<body>
  <h2>Skintelli Antioxidant Score</h2>
  <label>
    Choose card photo:
    <input type="file" id="file" accept="image/*">
  </label>
  <div id="out">â³ loading engineâ€¦</div>

  <script type="module">
    const out = document.getElementById('out');
    const show = txt => out.textContent = txt;

    try {
      // â”€â”€â”€ 1) Python â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      show('â³ loading Pythonâ€¦');
      const py = await loadPyodide({
        indexURL: "https://cdn.jsdelivr.net/pyodide/v0.25.1/full/"
      });
      await py.loadPackage(['numpy','pandas','scikit-image']);
      show('âœ… Python ready');

      // â”€â”€â”€ 2) OpenCV â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      show('â³ loading OpenCVâ€¦');
      await new Promise(resolve => { cv.onRuntimeInitialized = resolve; });
      show('âœ… OpenCV ready');

      // â”€â”€â”€ 3) Reference table â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      show('â³ loading reference tableâ€¦');
      const csvText = await fetch('trainingLab.csv').then(r => r.text());
      py.FS.writeFile('/tmp/training.csv', csvText);
      show('âœ… reference table loaded');

      // â”€â”€â”€ 4) Scorer â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      show('â³ compiling scorerâ€¦');
      await py.runPythonAsync(`
import numpy as np, pandas as pd, cv2 as cv
from skimage.color import rgb2lab, deltaE_ciede2000 as dE

# load lookup
df     = pd.read_csv('/tmp/training.csv')
LAB    = df[['L','a','b']].values
SCORES = df['score'].values

# constants
W, H   = 1000, 500
BOX    = 0.06; PAD = 0.08
PX, SY, CY = 0.92, 0.20, 0.60

def delta(l1, l2): return float(dE(l1[None], l2[None])[0])

def warp_card(img):
    h,w = img.shape[:2]
    g   = cv.GaussianBlur(cv.cvtColor(img,cv.COLOR_BGR2GRAY),(5,5),0)
    cnts,_ = cv.findContours(cv.Canny(g,50,150),
                             cv.RETR_EXTERNAL, cv.CHAIN_APPROX_SIMPLE)
    quad = max((c for c in cnts if 0.25*w*h < cv.contourArea(c) < 0.9*w*h),
               key=cv.contourArea, default=None)
    if quad is None: return cv.resize(img,(W,H))
    peri   = cv.arcLength(quad,True)
    approx = cv.approxPolyDP(quad,0.02*peri,True)
    if len(approx)!=4: return cv.resize(img,(W,H))
    pts = np.squeeze(approx).astype(np.float32)
    s   = pts.sum(1); d = np.diff(pts,axis=1).ravel()
    ord = np.array([pts[np.argmin(s)], pts[np.argmin(d)],
                    pts[np.argmax(s)], pts[np.argmax(d)]], np.float32)
    dst = np.array([[0,0],[W-1,0],[W-1,H-1],[0,H-1]], np.float32)
    return cv.warpPerspective(img, cv.getPerspectiveTransform(ord,dst), (W,H))

def crop_sq(img, cx, cy, pct):
    h,w  = img.shape[:2]
    side = int(pct * w)
    x0   = max(0, int(cx*w) - side//2)
    y0   = max(0, int(cy*h) - side//2)
    return img[y0:y0+side, x0:x0+side]

def med_lab(roi):
    lab = rgb2lab(cv.cvtColor(roi,cv.COLOR_BGR2RGB))
    return np.median(lab.reshape(-1,3), axis=0)

def score_array(bgr):
    card    = warp_card(bgr)
    printed = [med_lab(crop_sq(card, 0.05+i*0.13, 0.75, BOX)) for i in range(6)]
    sample  = med_lab(crop_sq(card, PX, SY, PAD))
    control = med_lab(crop_sq(card, PX, CY, PAD))
    wb      = np.array([95-control[0], -control[1], -control[2]])
    sc      = sample + wb
    pc      = [p+wb for p in printed]
    dists   = np.array([delta(sc, r) for r in LAB])
    if dists.min() <= 3: raw = SCORES[dists.argmin()]
    else:
        wts = np.exp(-np.array([delta(sc, p) for p in pc]) / 2.5)
        raw = (wts * np.arange(6)).sum() / wts.sum()
    return round(np.clip(raw, 0, 5) * 4) / 4

def score_from_js(buf, h, w):
    arr = np.frombuffer(buf, dtype=np.uint8).reshape(h, w, 3).copy()
    return score_array(arr)
`);
      show('âœ… Scorer ready â€” pick a photo.');

      // â”€â”€â”€ 5) File handler â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      document.getElementById('file').addEventListener('change', async ev => {
        const f = ev.target.files[0];
        if (!f) return;
        show('ğŸ–¼ï¸ decoding & scoringâ€¦');

        const buffer = await f.arrayBuffer();
        const u8     = new Uint8Array(buffer);
        const mat    = cv.matFromArray(u8, 1);
        const img    = cv.imdecode(mat, cv.IMREAD_COLOR);
        mat.delete();

        const { rows: h, cols: w } = img;
        const data = new Uint8Array(img.data);
        img.delete();

        py.globals.set('buf_js', data);
        py.globals.set('h', h);
        py.globals.set('w', w);
        const score = py.runPython('score_from_js(buf_js, int(h), int(w))');
        show('âœ… Antioxidant Score: ' + score);
      });
    }
    catch(err) {
      console.error(err);
      show('âš ï¸ ' + err.message);
    }
  </script>
</body>
</html>
