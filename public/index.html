<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Skintelli Card Capture</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<!--  ▸ rectangle detector  (≈120 KB gz) -->
<script src="https://cdn.jsdelivr.net/npm/jscanify@1.0.4/dist/jscanify.min.js"></script>
<!--  ▸ OCR fallback (≈180 KB gz – only loads if TextDetector absent) -->
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>

<style>
html,body{margin:0;height:100%;overflow:hidden;background:#000;font-family:-apple-system,Roboto,Helvetica,Arial}
#live,#preview{position:absolute;inset:0;display:flex;align-items:center;justify-content:center}
video,canvas{position:absolute;inset:0;width:100%;height:100%;object-fit:cover}
canvas{pointer-events:none;z-index:10}
/* hide ▶︎ overlay */
video::-webkit-media-controls-start-playback-button{display:none!important;-webkit-appearance:none}
#msg{position:absolute;top:14px;left:50%;transform:translateX(-50%);
     padding:6px 14px;border-radius:8px;background:rgba(0,0,0,.65);
     color:#fff;font-size:15px;z-index:20}
#hint{position:absolute;left:50%;transform:translateX(-50%);color:#fff;font-size:15px;text-align:center;z-index:20}
#fatal{position:absolute;inset:0;display:none;align-items:center;justify-content:center;
       background:rgba(0,0,0,.85);color:#fff;font-size:17px;text-align:center;z-index:40}
#snap{position:absolute;bottom:42px;left:50%;transform:translateX(-50%);width:80px;height:80px;border-radius:50%;
      border:4px solid #fff;background:rgba(255,255,255,.15);display:flex;align-items:center;justify-content:center;
      opacity:.35;pointer-events:none;transition:.2s}
#snap::after{content:'';width:54px;height:54px;border-radius:50%;background:#fff}
#snap.ready{opacity:1;pointer-events:auto}
#snap.ready::after{background:#0f0}
#preview{flex-direction:column;gap:18px;background:#000;display:none}
#shot{max-width:96%;max-height:96%;border:4px solid #fff;border-radius:10px}
.ctrls button{padding:12px 26px;border:none;border-radius:40px;background:#fff;margin:0 10px;font-size:16px}
</style>
</head>
<body>

<!-- ── live stage ── -->
<div id="live">
  <video id="vid" autoplay playsinline muted disablePictureInPicture></video>
  <canvas id="ov"></canvas>
  <div id="msg">Tap to enable camera</div><div id="hint"></div>
  <button id="snap"></button><div id="fatal"></div>
</div>

<!-- ── preview ── -->
<div id="preview">
  <img id="shot">
  <div class="ctrls"><button id="dl">Download</button><button id="rt">Retake</button></div>
</div>

<script>
/* ▸ constants */
const CARD_AR=1280/726,  PAD=.08, OCR=/SKINTELLI/i, DEST_W=1280;

/* ▸ DOM */
const v=document.getElementById('vid'),   ov=document.getElementById('ov'), ctx=ov.getContext('2d');
const msg=document.getElementById('msg'), hint=document.getElementById('hint'), fatal=document.getElementById('fatal');
const snap=document.getElementById('snap'), shot=document.getElementById('shot'), dl=document.getElementById('dl'), rt=document.getElementById('rt');
const live=document.getElementById('live'), prev=document.getElementById('preview');

/* ▸ globals */
let guide={}, okRect=false, okOcr=false, tWorker=null, lastOcr=0;
const off=document.createElement('canvas');

/* build horizontal guide once video known */
function setGuide(w,h){
  const maxW=w*(1-PAD*2); let gw=maxW, gh=gw/CARD_AR;
  if(gh>h*(1-PAD*2)){ gh=h*(1-PAD*2); gw=gh*CARD_AR; }
  guide={x:(w-gw)/2,y:(h-gh)/2,w:gw,h:gh};
}

/* draw L-corners + thirds */
function drawGreen(g){
  const {x,y,w,h}=guide, L=40;
  ctx.clearRect(0,0,ov.width,ov.height);
  ctx.lineWidth=6; ctx.strokeStyle=g?'#0f0':'#fff';
  ctx.beginPath();
  ctx.moveTo(x,y+L);ctx.lineTo(x,y);ctx.lineTo(x+L,y);
  ctx.moveTo(x+w-L,y);ctx.lineTo(x+w,y);ctx.lineTo(x+w,y+L);
  ctx.moveTo(x+w,y+h-L);ctx.lineTo(x+w,y+h);ctx.lineTo(x+w-L,y+h);
  ctx.moveTo(x+L,y+h);ctx.lineTo(x,y+h);ctx.lineTo(x,y+h-L); ctx.stroke();
  ctx.lineWidth=1; ctx.strokeStyle='rgba(255,255,255,.35)';
  for(let i=1;i<3;i++){
    ctx.beginPath();ctx.moveTo(x+w*i/3,y);ctx.lineTo(x+w*i/3,y+h);ctx.stroke();
    ctx.beginPath();ctx.moveTo(x,y+h*i/3);ctx.lineTo(x+w,y+h*i/3);ctx.stroke();}
  hint.style.top=`${y+h+20}px`;
}

/* OCR helper (native TextDetector → fallback Tesseract) */
async function hasWord(blob){
  if('TextDetector' in window){
    const res=await (new TextDetector).detect(await createImageBitmap(blob));
    return res.some(r=>OCR.test(r.rawValue));
  }
  if(!tWorker){
    tWorker=Tesseract.createWorker(); await tWorker.load(); await tWorker.loadLanguage('eng'); await tWorker.initialize('eng');
  }
  const { data:{ text } }=await tWorker.recognize(blob);
  return OCR.test(text);
}

/* main frame loop */
async function loop(){
  off.getContext('2d').drawImage(v,0,0);
  const {x,y,w,h}=guide, sub=off.getContext('2d').getImageData(x,y,w,h);
  /* rectangle detector */
  const quads=jscanify.detect(sub);
  okRect=false; if(quads.length){
    const q=quads[0], bw=q[1].x-q[0].x, bh=q[3].y-q[0].y;
    okRect=Math.abs(bw-w)/w<.1 && Math.abs(bh-h)/h<.1;
  }
  /* OCR step max once / second */
  if(okRect && Date.now()-lastOcr>1000){
    lastOcr=Date.now();
    const blob=await new Promise(r=>off.toBlob(r,'image/jpeg',0.6));
    okOcr = await hasWord(blob);
  }
  const ready=okRect&&okOcr;
  drawGreen(ready);
  hint.textContent= ready ? 'Hold steady and press shutter'
        : okRect ? 'Reading card…' : 'Move card fully inside brackets';
  msg.textContent = ready ? 'Ready – press shutter' : 'Align card inside brackets';
  snap.classList.toggle('ready',ready);
  requestAnimationFrame(loop);
}

/* boot after tap */
async function enable(){
  try{
    const s=await navigator.mediaDevices.getUserMedia({video:{facingMode:{ideal:'environment'}}});
    v.srcObject=s; await v.play();
  }catch(e){fatal.innerHTML=e.message;fatal.style.display='flex';return;}
  await new Promise(r=>v.onloadedmetadata=r);
  ov.width=off.width=v.videoWidth; ov.height=off.height=v.videoHeight;
  setGuide(ov.width,ov.height); msg.textContent='Align card inside brackets';
  requestAnimationFrame(loop);
}
document.body.addEventListener('touchstart',enable,{once:true});
document.body.addEventListener('click',enable,{once:true});

/* shutter */
snap.addEventListener('click',()=>{
  if(!snap.classList.contains('ready'))return;
  const {x,y,w,h}=guide;
  off.getContext('2d').drawImage(v,0,0);
  const out=document.createElement('canvas'); out.width=DEST_W; out.height=Math.round(DEST_W/CARD_AR);
  out.getContext('2d').drawImage(off,x,y,w,h,0,0,out.width,out.height);
  const url=out.toDataURL('image/jpeg',0.92);
  live.style.display='none'; prev.style.display='flex'; shot.src=url;
  dl.onclick=()=>{const a=document.createElement('a');a.href=url;a.download='card.jpg';a.click();};
  rt.onclick=()=>{prev.style.display='none';live.style.display='block';};
});
</script>
</body>
</html>
