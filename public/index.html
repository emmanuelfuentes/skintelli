<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Card Scanner</title>
<meta name="viewport" content="width=device-width,initial-scale=1">

<style>
/* ----- layout ----- */
html,body{margin:0;height:100%;overflow:hidden;background:#000;font-family:-apple-system,Roboto,Helvetica,Arial,sans-serif}
#cam,#preview{position:absolute;inset:0;display:flex;align-items:center;justify-content:center}
video,canvas{position:absolute;inset:0;width:100%;height:100%;object-fit:cover}
canvas{pointer-events:none;z-index:10}

/* top status */
#msg{position:absolute;top:14px;left:50%;transform:translateX(-50%);
     padding:6px 14px;border-radius:8px;background:rgba(0,0,0,.6);
     color:#fff;font-size:15px;z-index:20}

/* helper text */
#hint{position:absolute;left:50%;transform:translateX(-50%);
      color:#fff;font-size:15px;text-align:center;pointer-events:none;z-index:20}

/* fatal overlay */
#fatal{position:absolute;inset:0;display:none;align-items:center;justify-content:center;
       background:rgba(0,0,0,.85);color:#fff;font-size:17px;text-align:center;padding:24px;z-index:40}

/* shutter */
#snap{position:absolute;bottom:42px;left:50%;transform:translateX(-50%);
      width:80px;height:80px;border-radius:50%;border:4px solid #fff;
      background:rgba(255,255,255,.15);display:flex;align-items:center;justify-content:center;
      opacity:.3;pointer-events:none;transition:.2s ease;z-index:20}
#snap::after{content:'';width:54px;height:54px;border-radius:50%;background:#fff}
#snap.ready{opacity:1}
#snap.ready::after{background:#0f0}

/* preview */
#preview{flex-direction:column;gap:18px;background:#000;display:none}
#shot{max-width:96%;max-height:96%;border:4px solid #fff;border-radius:10px}
.ctrls button{padding:12px 26px;font-size:16px;border:none;border-radius:40px;margin:0 10px;background:#fff}
</style>
</head>
<body>

<!-- ─── live camera stage ─── -->
<div id="cam">
  <video id="video" autoplay playsinline muted></video>
  <canvas id="overlay"></canvas>

  <div id="msg">Loading OpenCV…</div>
  <div id="hint"></div>
  <button id="snap" aria-label="Shutter"></button>

  <div id="fatal"></div>
</div>

<!-- ─── preview stage ─── -->
<div id="preview">
  <img id="shot" alt="">
  <div class="ctrls">
    <button id="save">Download</button>
    <button id="retake">Retake</button>
  </div>
</div>

<!-- OpenCV.js -->
<script src="https://docs.opencv.org/4.x/opencv.js"></script>

<script type="module">
/* === tweakables === */
const CARD_RATIO   = 1280/726;
const RATIO_TOL    = 0.35;
const COVER_REQ    = 0.35;
const BRIGHT_MIN   = 45;
const GUIDE_MARGIN = 0.08;
const DEST_W       = 1280;

/* === DOM refs === */
const vid  = document.getElementById('video');
const can  = document.getElementById('overlay');
const ctx  = can.getContext('2d');
const msg  = document.getElementById('msg');
const hint = document.getElementById('hint');
const fatal= document.getElementById('fatal');
const snap = document.getElementById('snap');
const shot = document.getElementById('shot');
const save = document.getElementById('save');
const ret  = document.getElementById('retake');
const camStage = document.getElementById('cam');
const prevStage= document.getElementById('preview');

/* === globals === */
let ready=false, quad=null, brightOK=false, ratioOK=false, coverOK=false;

/* off-screen canvas */
const off = document.createElement('canvas');

/* wait for OpenCV */
cv.onRuntimeInitialized = () => {
  msg.textContent = 'Tap to enable camera';
  const kick = ()=>{ document.removeEventListener('touchstart',kick); document.removeEventListener('click',kick); initCamera(); };
  document.addEventListener('touchstart',kick,{once:true});
  document.addEventListener('click',kick,{once:true});
};

/* ---------- camera init ---------- */
async function initCamera(){
  try{
    msg.textContent='Requesting camera…';
    const stream = await navigator.mediaDevices.getUserMedia({
      video:{facingMode:{ideal:'environment'}}
    });
    vid.srcObject = stream;
    await vid.play().catch(()=>{});

    const watchdog=setTimeout(()=>fatalError('Camera timed out.<br>Close other apps using the lens.'),4000);

    vid.onloadedmetadata = ()=>{
      clearTimeout(watchdog);
      can.width = off.width  = vid.videoWidth;
      can.height= off.height = vid.videoHeight;
      msg.textContent='Align card inside brackets';
      requestAnimationFrame(loop);
    };

  }catch(e){
    fatalError(
      e.name==='NotAllowedError'
        ? 'Camera permission denied.<br>Safari → aA → “Website Settings” → Camera → Allow'
        : `Could not access camera:<br>${e.message}`
    );
  }
}

/* ---------- main loop ---------- */
function loop(){
  if(vid.readyState<2){requestAnimationFrame(loop);return;}

  off.getContext('2d').drawImage(vid,0,0);

  /* brightness */
  const tiny = off.getContext('2d').getImageData(0,0,8,8).data;
  let lum=0; for(let i=0;i<tiny.length;i+=4) lum+=(tiny[i]+tiny[i+1]+tiny[i+2])/3;
  brightOK = (lum/16) > BRIGHT_MIN;

  /* contour detection */
  ready=false; quad=null; ratioOK=coverOK=false;
  try{
    const src=cv.imread(off);
    cv.cvtColor(src,src,cv.COLOR_RGBA2GRAY);
    cv.Canny(src,src,60,120);

    const cnts=new cv.MatVector(), hier=new cv.Mat();
    cv.findContours(src,cnts,hier,cv.RETR_EXTERNAL,cv.CHAIN_APPROX_SIMPLE);

    let best=null, area=0;
    for(let i=0;i<cnts.size();i++){
      const c=cnts.get(i), a=cv.contourArea(c);
      if(a>area){area=a;best=c;}
    }
    if(best){
      const peri=cv.arcLength(best,true), approx=new cv.Mat();
      cv.approxPolyDP(best,approx,0.02*peri,true);
      if(approx.rows===4){
        const pts=[]; for(let i=0;i<4;i++) pts.push({x:approx.intAt(i,0),y:approx.intAt(i,1)});
        pts.sort((a,b)=>a.x+a.y-(b.x+b.y));
        const [tl,br]=[pts[0],pts[3]];
        const rest=[pts[1],pts[2]].sort((a,b)=>a.x-b.x);
        const [tr,bl]=rest;
        quad=[tl,tr,br,bl];

        const w=Math.hypot(tr.x-tl.x,tr.y-tl.y),
              h=Math.hypot(bl.x-tl.x,bl.y-tl.y);
        ratioOK=Math.abs(w/h-CARD_RATIO)/CARD_RATIO<RATIO_TOL;
        coverOK=(area/(can.width*can.height))>COVER_REQ;
        ready = brightOK && ratioOK && coverOK;
      }
      approx.delete();
    }
    src.delete(); cnts.delete(); hier.delete();
  }catch(e){console.error(e);}

  drawGuide(ready);
  updateHint();
  msg.textContent = brightOK
      ? (ready?'Ready – press shutter':'Align card inside brackets')
      : 'Add more light';
  snap.classList.toggle('ready',ready);

  requestAnimationFrame(loop);
}

/* ---------- brackets & hint pos ---------- */
function drawGuide(green){
  const W=can.width,H=can.height;
  ctx.clearRect(0,0,W,H);

  const maxW=W*(1-GUIDE_MARGIN*2);
  let gw=maxW, gh=gw/CARD_RATIO;
  if(gh>H*(1-GUIDE_MARGIN*2)){gh=H*(1-GUIDE_MARGIN*2);gw=gh*CARD_RATIO;}
  const x=(W-gw)/2, y=(H-gh)/2;

  hint.style.top=`${y+gh+20}px`;

  ctx.lineWidth=6; ctx.strokeStyle=green?'#0f0':'#fff';
  const L=40;
  ctx.beginPath();
  ctx.moveTo(x,y+L);ctx.lineTo(x,y);ctx.lineTo(x+L,y);
  ctx.moveTo(x+gw-L,y);ctx.lineTo(x+gw,y);ctx.lineTo(x+gw,y+L);
  ctx.moveTo(x+gw,y+gh-L);ctx.lineTo(x+gw,y+gh);ctx.lineTo(x+gw-L,y+gh);
  ctx.moveTo(x+L,y+gh);ctx.lineTo(x,y+gh);ctx.lineTo(x,y+gh-L);
  ctx.stroke();
}

/* ---------- dynamic hint ---------- */
function updateHint(){
  if(ready){hint.textContent='Hold steady and press shutter';return;}
  if(!brightOK){hint.textContent='Add more light';return;}
  if(!coverOK){hint.textContent='Move card fully inside brackets';return;}
  if(!ratioOK){hint.textContent='Keep card level (not tilted)';return;}
  hint.textContent='';
}

/* ---------- shutter ---------- */
snap.onclick=()=>{
  if(!ready||!quad)return;

  const src=cv.imread(off);
  const dstSz=new cv.Size(DEST_W,Math.round(DEST_W/CARD_RATIO));
  const srcTri=cv.matFromArray(4,1,cv.CV_32FC2,quad.flatMap(p=>[p.x,p.y]));
  const dstTri=cv.matFromArray(4,1,cv.CV_32FC2,[0,0,dstSz.width,0,dstSz.width,dstSz.height,0,dstSz.height]);
  const M=cv.getPerspectiveTransform(srcTri,dstTri);
  const dst=new cv.Mat();
  cv.warpPerspective(src,dst,M,dstSz,cv.INTER_LINEAR,cv.BORDER_CONSTANT);

  const out=document.createElement('canvas');
  out.width=dstSz.width; out.height=dstSz.height;
  cv.imshow(out,dst);
  const url=out.toDataURL('image/jpeg',0.92);

  camStage.style.display='none'; prevStage.style.display='flex';
  shot.src=url;
  save.onclick=()=>{const a=document.createElement('a');a.href=url;a.download='card.jpg';a.click();};
  ret.onclick =()=>{prevStage.style.display='none';camStage.style.display='block';};

  src.delete(); dst.delete(); M.delete(); srcTri.delete(); dstTri.delete();
};

/* ---------- fatal overlay ---------- */
function fatalError(html){
  fatal.innerHTML=html;
  fatal.style.display='flex';
  msg.style.display='none';
  snap.style.display='none';
}
</script>
</body>
</html>
