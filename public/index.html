<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Card Scanner (pure JS – fixed)</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
/* -------- layout / styling (unchanged) -------- */
html,body{margin:0;height:100%;overflow:hidden;background:#000;font-family:-apple-system,Roboto,Helvetica,Arial,sans-serif}
#cam,#preview{position:absolute;inset:0;display:flex;align-items:center;justify-content:center}
video,canvas{position:absolute;inset:0;width:100%;height:100%;object-fit:cover}
canvas{pointer-events:none;z-index:10}
#msg{position:absolute;top:14px;left:50%;transform:translateX(-50%);padding:6px 14px;border-radius:8px;background:rgba(0,0,0,.65);color:#fff;font-size:15px;z-index:20}
#hint{position:absolute;left:50%;transform:translateX(-50%);color:#fff;font-size:15px;text-align:center;pointer-events:none;z-index:20}
#fatal{position:absolute;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.85);color:#fff;font-size:17px;text-align:center;padding:24px;z-index:40}
#snap{position:absolute;bottom:42px;left:50%;transform:translateX(-50%);width:80px;height:80px;border-radius:50%;border:4px solid #fff;background:rgba(255,255,255,.15);display:flex;align-items:center;justify-content:center;opacity:.3;pointer-events:none;transition:.2s ease;z-index:20}
#snap::after{content:'';width:54px;height:54px;border-radius:50%;background:#fff}
#snap.ready{opacity:1}
#snap.ready::after{background:#0f0}
#preview{flex-direction:column;gap:18px;background:#000;display:none}
#shot{max-width:96%;max-height:96%;border:4px solid #fff;border-radius:10px}
.ctrls button{padding:12px 26px;font-size:16px;border:none;border-radius:40px;margin:0 10px;background:#fff}
</style>
</head>
<body>

<!-- live camera stage -->
<div id="cam">
  <video id="video" autoplay playsinline muted></video>
  <canvas id="overlay"></canvas>

  <div id="msg">Tap to enable camera</div>
  <div id="hint"></div>
  <button id="snap" aria-label="Shutter"></button>

  <div id="fatal"></div>
</div>

<!-- preview stage -->
<div id="preview">
  <img id="shot" alt="">
  <div class="ctrls">
    <button id="download">Download</button>
    <button id="retake">Retake</button>
  </div>
</div>

<script type="module">
/* ===== tweakables ===== */
const CARD_RATIO   = 1280/726;     // 1.76 : 1
const GUIDE_MARGIN = 0.10;         // 8 % padding
const BRIGHT_MIN   = 55;           // mean luminance
const COVER_MIN    = 0.85;         // bounding-box coverage
const AR_TOL       = 0.35;         // ±15 % of true ratio
const EDGE_MIN     = 400;          // # edge pixels
const DEST_W       = 1280;         // output width

/* ===== DOM refs ===== */
const video = document.getElementById('video');
const overlay = document.getElementById('overlay');
const ctx = overlay.getContext('2d');
const msg  = document.getElementById('msg');
const hint = document.getElementById('hint');
const fatal= document.getElementById('fatal');
const snap = document.getElementById('snap');
const shot = document.getElementById('shot');
const dl   = document.getElementById('download');
const rt   = document.getElementById('retake');
const camStage  = document.getElementById('cam');
const prevStage = document.getElementById('preview');

/* ===== globals ===== */
let guide = null;
let ready = false;

/* off-screen canvas */
const off = document.createElement('canvas');

/* ===== boot after first user gesture ===== */
const kick = () => { document.removeEventListener('touchstart',kick); document.removeEventListener('click',kick); initCamera(); };
document.addEventListener('touchstart',kick,{once:true});
document.addEventListener('click',kick,{once:true});

/* ===== camera init ===== */
async function initCamera(){
  msg.textContent = 'Requesting camera…';
  try{
    const stream = await navigator.mediaDevices.getUserMedia({ video:{ facingMode:{ideal:'environment'} } });
    video.srcObject = stream;
    await video.play().catch(()=>{});
  }catch(err){
    fatalError(
      err.name==='NotAllowedError'
        ? 'Camera permission denied.<br>Safari → aA → Website Settings → Camera → Allow'
        : `Could not access camera:<br>${err.message}`
    );
    return;
  }

  const boot = () => {
    if (!video.videoWidth) return;
    overlay.width  = off.width  = video.videoWidth;
    overlay.height = off.height = video.videoHeight;
    guide = calcGuide(overlay.width, overlay.height);
    msg.textContent = 'Align card inside brackets';
    requestAnimationFrame(loop);
    video.removeEventListener('playing',boot);
    video.removeEventListener('loadedmetadata',boot);
    clearInterval(poll);
  };
  video.addEventListener('playing', boot, { once:true });
  video.addEventListener('loadedmetadata', boot, { once:true });
  const poll = setInterval(boot, 100);
}

/* ===== helper: guide rectangle ===== */
function calcGuide(W,H){
  const maxW = W*(1-GUIDE_MARGIN*2);
  let gw=maxW, gh=gw/CARD_RATIO;
  if(gh>H*(1-GUIDE_MARGIN*2)){ gh=H*(1-GUIDE_MARGIN*2); gw=gh*CARD_RATIO; }
  return { gx:(W-gw)/2, gy:(H-gh)/2, gw, gh };
}

/* ===== helper: draw brackets ===== */
function drawBrackets(isGreen){
  const {gx,gy,gw,gh}=guide;
  ctx.clearRect(0,0,overlay.width,overlay.height);

  const L=40;
  ctx.lineWidth = 6;
  ctx.strokeStyle = isGreen ? '#0f0' : '#fff';

  ctx.beginPath();
  ctx.moveTo(gx,gy+L);          ctx.lineTo(gx,gy);          ctx.lineTo(gx+L,gy);
  ctx.moveTo(gx+gw-L,gy);       ctx.lineTo(gx+gw,gy);       ctx.lineTo(gx+gw,gy+L);
  ctx.moveTo(gx+gw,gy+gh-L);    ctx.lineTo(gx+gw,gy+gh);    ctx.lineTo(gx+gw-L,gy+gh);
  ctx.moveTo(gx+L,gy+gh);       ctx.lineTo(gx,gy+gh);       ctx.lineTo(gx,gy+gh-L);
  ctx.stroke();

  ctx.lineWidth = 1;
  ctx.strokeStyle = 'rgba(255,255,255,.4)';
  for(let i=1;i<3;i++){
    ctx.beginPath(); ctx.moveTo(gx+gw*i/3,gy);     ctx.lineTo(gx+gw*i/3,gy+gh); ctx.stroke();
    ctx.beginPath(); ctx.moveTo(gx,gy+gh*i/3);     ctx.lineTo(gx+gw,gy+gh*i/3); ctx.stroke();
  }

  hint.style.top = `${gy+gh+20}px`;
}

/* ===== edge detector ===== */
function rectPresent(image,w,h){
  let minX=w, minY=h, maxX=0, maxY=0, edges=0;
  for(let y=0;y<h-1;y++){
    for(let x=0;x<w-1;x++){
      const i=(y*w+x)*4;
      const lum   =(image[i]+image[i+1]+image[i+2])/3;
      const lumR  =(image[i+4]+image[i+5]+image[i+6])/3;
      const lumD  =(image[i+w*4]+image[i+w*4+1]+image[i+w*4+2])/3;
      if(Math.abs(lum-lumR)>25 || Math.abs(lum-lumD)>25){
        edges++;
        if(x<minX)minX=x; if(y<minY)minY=y;
        if(x>maxX)maxX=x; if(y>maxY)maxY=y;
      }
    }
  }
  if(edges<EDGE_MIN) return false;
  const bw=maxX-minX, bh=maxY-minY;
  if(bw<=0||bh<=0)   return false;
  const coverW=bw/w, coverH=bh/h;
  const ar=bw/bh, arOK=Math.abs(ar-CARD_RATIO)/CARD_RATIO<AR_TOL;
  return coverW>COVER_MIN && coverH>COVER_MIN && arOK;
}

/* ===== main loop ===== */
function loop(){
  if(video.readyState<2){requestAnimationFrame(loop);return;}
  off.getContext('2d').drawImage(video,0,0);

  const {gx,gy,gw,gh}=guide;
  const sample = off.getContext('2d').getImageData(gx,gy,gw,gh);
  /* brightness */
  let lum=0; const d=sample.data;
  for(let i=0;i<d.length;i+=4) lum+=(d[i]+d[i+1]+d[i+2])/3;
  const brightOK = (lum/(d.length/4)) > BRIGHT_MIN;
  /* rectangle */
  const rectOK   = rectPresent(d,gw,gh);

  ready = brightOK && rectOK;
  drawBrackets(ready);

  hint.textContent = ready
      ? 'Hold steady and press shutter'
      : (brightOK ? 'Move card fully inside brackets' : 'Add more light');

  msg.textContent = ready ? 'Ready – press shutter' : 'Align card inside brackets';
  snap.classList.toggle('ready', ready);

  requestAnimationFrame(loop);
}

/* ===== shutter ===== */
snap.onclick = () => {
  if(!ready) return;

  const {gx,gy,gw,gh} = guide;
  off.getContext('2d').drawImage(video,0,0);

  /* crop & scale */
  const out = document.createElement('canvas');
  out.width  = DEST_W;
  out.height = Math.round(DEST_W/CARD_RATIO);
  out.getContext('2d').drawImage(off,gx,gy,gw,gh,0,0,out.width,out.height);

  const url = out.toDataURL('image/jpeg',0.92);
  camStage.style.display='none'; prevStage.style.display='flex';
  shot.src = url;

  dl.onclick = () => { const a=document.createElement('a'); a.href=url; a.download='card.jpg'; a.click(); };
  rt.onclick = () => { prevStage.style.display='none'; camStage.style.display='block'; };
};

/* ===== fatal helper ===== */
function fatalError(html){
  fatal.innerHTML = html;
  fatal.style.display = 'flex';
  msg.style.display   = 'none';
  snap.style.display  = 'none';
}
</script>
</body>
</html>
